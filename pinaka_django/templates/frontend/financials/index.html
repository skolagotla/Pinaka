{% extends 'frontend/base.html' %}

{% block title %}Financials - Pinaka{% endblock %}

{% block content %}
<div class="p-6" x-data="financials()" x-init="init()">
    <!-- Page Header -->
    <div class="mb-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Financial Dashboard</h1>
                <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">Track income, expenses, and financial performance</p>
            </div>
            <div class="flex space-x-2">
                <button @click="exportReport('csv')" 
                        class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700">
                    <i class="fas fa-file-csv mr-2"></i>Export CSV
                </button>
                <button @click="exportReport('pdf')" 
                        class="inline-flex items-center px-4 py-2 border border-transparent rounded-lg text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                    <i class="fas fa-file-pdf mr-2"></i>Export PDF
                </button>
            </div>
        </div>
    </div>

    <!-- Financial Metrics -->
    <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4 mb-8">
        <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0 bg-green-100 dark:bg-green-900 rounded-md p-3">
                        <i class="fas fa-dollar-sign text-2xl text-green-600 dark:text-green-400"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Total Income</dt>
                            <dd class="text-2xl font-semibold text-gray-900 dark:text-white" x-text="formatCurrency(financialData.total_income)"></dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0 bg-red-100 dark:bg-red-900 rounded-md p-3">
                        <i class="fas fa-receipt text-2xl text-red-600 dark:text-red-400"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Total Expenses</dt>
                            <dd class="text-2xl font-semibold text-gray-900 dark:text-white" x-text="formatCurrency(financialData.total_expenses)"></dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0 bg-blue-100 dark:bg-blue-900 rounded-md p-3">
                        <i class="fas fa-wallet text-2xl text-blue-600 dark:text-blue-400"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Net Income</dt>
                            <dd class="text-2xl font-semibold" :class="financialData.net_income >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'" x-text="formatCurrency(financialData.net_income)"></dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0 bg-yellow-100 dark:bg-yellow-900 rounded-md p-3">
                        <i class="fas fa-clock text-2xl text-yellow-600 dark:text-yellow-400"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Pending Payments</dt>
                            <dd class="text-2xl font-semibold text-gray-900 dark:text-white" x-text="financialData.pending_payments"></dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow mb-6">
        <div class="border-b border-gray-200 dark:border-gray-700">
            <nav class="flex -mb-px" aria-label="Tabs">
                <button @click="activeTab = 'overview'" 
                        :class="activeTab === 'overview' ? 'border-blue-500 text-blue-600 dark:text-blue-400' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300'"
                        class="flex items-center px-6 py-4 text-sm font-medium border-b-2">
                    <i class="fas fa-wallet mr-2"></i>Overview
                </button>
                <button @click="activeTab = 'charts'" 
                        :class="activeTab === 'charts' ? 'border-blue-500 text-blue-600 dark:text-blue-400' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300'"
                        class="flex items-center px-6 py-4 text-sm font-medium border-b-2">
                    <i class="fas fa-chart-bar mr-2"></i>Charts
                </button>
                <button @click="activeTab = 'reports'" 
                        :class="activeTab === 'reports' ? 'border-blue-500 text-blue-600 dark:text-blue-400' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300'"
                        class="flex items-center px-6 py-4 text-sm font-medium border-b-2">
                    <i class="fas fa-file-alt mr-2"></i>Reports
                </button>
            </nav>
        </div>

        <!-- Tab Content -->
        <div class="p-6">
            <!-- Overview Tab -->
            <div x-show="activeTab === 'overview'">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Recent Payments -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Recent Payments</h3>
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 max-h-96 overflow-y-auto">
                            <template x-for="payment in recentPayments" :key="payment.id">
                                <div class="flex items-center justify-between py-3 border-b border-gray-200 dark:border-gray-600 last:border-0">
                                    <div>
                                        <p class="text-sm font-medium text-gray-900 dark:text-white" x-text="payment.property_name"></p>
                                        <p class="text-xs text-gray-500 dark:text-gray-400" x-text="payment.tenant_name"></p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm font-semibold text-green-600 dark:text-green-400" x-text="formatCurrency(payment.amount)"></p>
                                        <p class="text-xs text-gray-500 dark:text-gray-400" x-text="formatDate(payment.paid_date)"></p>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Recent Expenses -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Recent Expenses</h3>
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 max-h-96 overflow-y-auto">
                            <template x-for="expense in recentExpenses" :key="expense.id">
                                <div class="flex items-center justify-between py-3 border-b border-gray-200 dark:border-gray-600 last:border-0">
                                    <div>
                                        <p class="text-sm font-medium text-gray-900 dark:text-white" x-text="expense.description"></p>
                                        <p class="text-xs text-gray-500 dark:text-gray-400" x-text="expense.category"></p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm font-semibold text-red-600 dark:text-red-400" x-text="formatCurrency(expense.amount)"></p>
                                        <p class="text-xs text-gray-500 dark:text-gray-400" x-text="formatDate(expense.date)"></p>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Tab -->
            <div x-show="activeTab === 'charts'">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Income vs Expenses Chart -->
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Income vs Expenses</h3>
                        <canvas id="incomeExpensesChart" height="300"></canvas>
                    </div>

                    <!-- Monthly Trend Chart -->
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Monthly Trend</h3>
                        <canvas id="monthlyTrendChart" height="300"></canvas>
                    </div>

                    <!-- Expenses by Category -->
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Expenses by Category</h3>
                        <canvas id="expensesPieChart" height="300"></canvas>
                    </div>

                    <!-- Cash Flow Chart -->
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Cash Flow</h3>
                        <canvas id="cashFlowChart" height="300"></canvas>
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div x-show="activeTab === 'reports'">
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Financial Reports</h3>
                    <div class="flex space-x-4">
                        <button @click="generateReport('monthly')" 
                                class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700">
                            Monthly Report
                        </button>
                        <button @click="generateReport('yearly')" 
                                class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700">
                            Yearly Report
                        </button>
                        <button @click="generateReport('custom')" 
                                class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700">
                            Custom Period
                        </button>
                    </div>
                </div>

                <div x-show="reportData" class="bg-gray-50 dark:bg-gray-700 rounded-lg p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-md font-semibold text-gray-900 dark:text-white" x-text="reportData.title"></h4>
                        <div class="flex space-x-2">
                            <button @click="exportReport('csv')" class="text-sm text-blue-600 dark:text-blue-400 hover:text-blue-800">
                                <i class="fas fa-file-csv mr-1"></i>CSV
                            </button>
                            <button @click="exportReport('pdf')" class="text-sm text-blue-600 dark:text-blue-400 hover:text-blue-800">
                                <i class="fas fa-file-pdf mr-1"></i>PDF
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
                            <thead class="bg-gray-100 dark:bg-gray-800">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase">Property</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase">Income</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase">Expenses</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase">Net</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white dark:bg-gray-700 divide-y divide-gray-200 dark:divide-gray-600">
                                <template x-for="row in reportData.rows" :key="row.property">
                                    <tr>
                                        <td class="px-4 py-3 text-sm text-gray-900 dark:text-white" x-text="row.property"></td>
                                        <td class="px-4 py-3 text-sm text-green-600 dark:text-green-400" x-text="formatCurrency(row.income)"></td>
                                        <td class="px-4 py-3 text-sm text-red-600 dark:text-red-400" x-text="formatCurrency(row.expenses)"></td>
                                        <td class="px-4 py-3 text-sm font-semibold" :class="row.net >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'" x-text="formatCurrency(row.net)"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
function financials() {
    return {
        activeTab: 'overview',
        financialData: {
            total_income: {{ total_income|default:0 }},
            total_expenses: {{ total_expenses|default:0 }},
            net_income: {{ net_income|default:0 }},
            pending_payments: {{ pending_payments|default:0 }},
        },
        recentPayments: [],
        recentExpenses: [],
        monthlyData: {{ monthly_data|safe }},
        reportData: null,
        charts: {},

        async init() {
            await this.loadData();
            this.setupCharts();
        },

        async loadData() {
            try {
                // Load recent payments
                const paymentsResponse = await fetch('/api/v1/payments/?limit=10');
                const paymentsData = await paymentsResponse.json();
                if (paymentsData.success) {
                    this.recentPayments = paymentsData.data || [];
                }

                // Load recent expenses
                const expensesResponse = await fetch('/api/v1/expenses/?limit=10');
                const expensesData = await expensesResponse.json();
                if (expensesData.success) {
                    this.recentExpenses = expensesData.data || [];
                }
            } catch (err) {
                console.error('Failed to load data:', err);
            }
        },

        setupCharts() {
            // Income vs Expenses Chart
            const incomeExpensesCtx = document.getElementById('incomeExpensesChart');
            if (incomeExpensesCtx) {
                this.charts.incomeExpenses = new Chart(incomeExpensesCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Income', 'Expenses'],
                        datasets: [{
                            label: 'Amount',
                            data: [this.financialData.total_income, this.financialData.total_expenses],
                            backgroundColor: ['#22c55e', '#ef4444'],
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (context) => '$' + context.parsed.y.toLocaleString()
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: (value) => '$' + value.toLocaleString()
                                }
                            }
                        }
                    }
                });
            }

            // Monthly Trend Chart
            const monthlyTrendCtx = document.getElementById('monthlyTrendChart');
            if (monthlyTrendCtx && this.monthlyData) {
                this.charts.monthlyTrend = new Chart(monthlyTrendCtx, {
                    type: 'line',
                    data: {
                        labels: this.monthlyData.map(d => d.month),
                        datasets: [{
                            label: 'Income',
                            data: this.monthlyData.map(d => d.income),
                            borderColor: '#22c55e',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true },
                            tooltip: {
                                callbacks: {
                                    label: (context) => '$' + context.parsed.y.toLocaleString()
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: (value) => '$' + value.toLocaleString()
                                }
                            }
                        }
                    }
                });
            }

            // Expenses Pie Chart
            const expensesPieCtx = document.getElementById('expensesPieChart');
            if (expensesPieCtx) {
                // Group expenses by category
                const categoryTotals = {};
                this.recentExpenses.forEach(exp => {
                    categoryTotals[exp.category] = (categoryTotals[exp.category] || 0) + exp.amount;
                });

                this.charts.expensesPie = new Chart(expensesPieCtx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(categoryTotals),
                        datasets: [{
                            data: Object.values(categoryTotals),
                            backgroundColor: [
                                '#ef4444', '#f59e0b', '#3b82f6', '#8b5cf6', '#ec4899', '#10b981'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'right' },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        return label + ': $' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Cash Flow Chart
            const cashFlowCtx = document.getElementById('cashFlowChart');
            if (cashFlowCtx && this.monthlyData) {
                this.charts.cashFlow = new Chart(cashFlowCtx, {
                    type: 'bar',
                    data: {
                        labels: this.monthlyData.map(d => d.month),
                        datasets: [{
                            label: 'Income',
                            data: this.monthlyData.map(d => d.income),
                            backgroundColor: '#22c55e',
                        }, {
                            label: 'Expenses',
                            data: this.monthlyData.map(d => d.expenses || 0),
                            backgroundColor: '#ef4444',
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true },
                            tooltip: {
                                callbacks: {
                                    label: (context) => '$' + context.parsed.y.toLocaleString()
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: (value) => '$' + value.toLocaleString()
                                }
                            }
                        }
                    }
                });
            }
        },

        async generateReport(type) {
            try {
                const params = new URLSearchParams({ type });
                const response = await fetch(`/api/v1/financials/reports/?${params.toString()}`);
                const data = await response.json();
                if (data.success) {
                    this.reportData = data.data;
                }
            } catch (err) {
                alert('Failed to generate report: ' + err.message);
            }
        },

        async exportReport(format) {
            try {
                const params = new URLSearchParams({ format });
                const response = await fetch(`/api/v1/financials/export/?${params.toString()}`);
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `financial-report.${format}`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            } catch (err) {
                alert('Failed to export report: ' + err.message);
            }
        },

        formatCurrency(amount) {
            return '$' + (amount || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        },

        formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        },
    };
}
</script>
{% endblock %}
