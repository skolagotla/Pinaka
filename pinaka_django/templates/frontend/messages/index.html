{% extends 'frontend/base.html' %}

{% block title %}Messages - Pinaka{% endblock %}

{% block content %}
<div class="p-6" x-data="messages()" x-init="init()">
    <!-- Page Header -->
    <div class="mb-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Messages</h1>
                <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">Communicate with your team</p>
            </div>
            <button @click="showNewConversationModal = true" 
                    class="inline-flex items-center px-4 py-2 border border-transparent rounded-lg text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                <i class="fas fa-plus mr-2"></i>New Conversation
            </button>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Conversations List -->
        <div class="lg:col-span-1 bg-white dark:bg-gray-800 rounded-lg shadow">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Conversations</h2>
            </div>
            <div class="overflow-y-auto max-h-[600px]">
                <template x-for="conversation in conversations" :key="conversation.id">
                    <div @click="selectConversation(conversation.id)" 
                         :class="selectedConversationId === conversation.id ? 'bg-blue-50 dark:bg-blue-900' : 'hover:bg-gray-50 dark:hover:bg-gray-700'"
                         class="p-4 border-b border-gray-200 dark:border-gray-700 cursor-pointer">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-medium text-gray-900 dark:text-white" x-text="conversation.property_name || 'General'"></h3>
                            <span class="text-xs text-gray-500 dark:text-gray-400" x-text="formatTime(conversation.last_message_at)"></span>
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-400 truncate" x-text="conversation.last_message || 'No messages'"></p>
                        <div x-show="conversation.unread_count > 0" class="mt-2">
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200" x-text="conversation.unread_count + ' new'"></span>
                        </div>
                    </div>
                </template>
                <div x-show="conversations.length === 0" class="p-8 text-center">
                    <i class="fas fa-comments text-4xl text-gray-300 dark:text-gray-600 mb-4"></i>
                    <p class="text-sm text-gray-500 dark:text-gray-400">No conversations yet</p>
                </div>
            </div>
        </div>

        <!-- Messages Area -->
        <div class="lg:col-span-2 bg-white dark:bg-gray-800 rounded-lg shadow flex flex-col" style="height: 600px;">
            <div x-show="selectedConversationId" class="flex-1 flex flex-col">
                <!-- Conversation Header -->
                <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white" x-text="selectedConversation?.property_name || 'Conversation'"></h3>
                </div>

                <!-- Messages List -->
                <div class="flex-1 overflow-y-auto p-4 space-y-4" id="messages-container">
                    <template x-for="message in messages" :key="message.id">
                        <div :class="message.sender_id === currentUserId ? 'ml-auto' : 'mr-auto'" class="max-w-xs lg:max-w-md">
                            <div :class="message.sender_id === currentUserId ? 'bg-blue-600 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white'" 
                                 class="rounded-lg p-3">
                                <p class="text-sm" x-text="message.content"></p>
                                <p class="text-xs mt-1 opacity-75" x-text="formatDateTime(message.created_at)"></p>
                            </div>
                        </div>
                    </template>
                    <div x-show="messages.length === 0" class="text-center py-12">
                        <i class="fas fa-comment text-4xl text-gray-300 dark:text-gray-600 mb-4"></i>
                        <p class="text-sm text-gray-500 dark:text-gray-400">No messages yet. Start the conversation!</p>
                    </div>
                </div>

                <!-- Message Input -->
                <div class="p-4 border-t border-gray-200 dark:border-gray-700">
                    <form @submit.prevent="sendMessage()" class="flex space-x-2">
                        <input type="text" x-model="newMessage" 
                               placeholder="Type a message..."
                               class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <button type="submit" 
                                :disabled="!newMessage.trim() || sending"
                                class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                </div>
            </div>

            <!-- No Conversation Selected -->
            <div x-show="!selectedConversationId" class="flex-1 flex items-center justify-center">
                <div class="text-center">
                    <i class="fas fa-comments text-6xl text-gray-300 dark:text-gray-600 mb-4"></i>
                    <p class="text-lg font-medium text-gray-900 dark:text-white mb-2">Select a conversation</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Choose a conversation from the list to start messaging</p>
                </div>
            </div>
        </div>
    </div>

    <!-- New Conversation Modal -->
    <div x-show="showNewConversationModal" @click.away="showNewConversationModal = false" 
         class="fixed inset-0 z-50 overflow-y-auto" style="background-color: rgba(0, 0, 0, 0.75);">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full">
                <div class="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">New Conversation</h3>
                    <button @click="showNewConversationModal = false" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div class="p-6">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Property</label>
                        <select x-model="newConversationProperty" 
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            <option value="">Select Property</option>
                            <template x-for="property in properties" :key="property.id">
                                <option :value="property.id" x-text="property.property_name"></option>
                            </template>
                        </select>
                    </div>
                    <div class="flex items-center justify-end space-x-2">
                        <button @click="showNewConversationModal = false" 
                                class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg">
                            Cancel
                        </button>
                        <button @click="createConversation()" 
                                :disabled="!newConversationProperty"
                                class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">
                            Create
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function messages() {
    return {
        conversations: [],
        selectedConversationId: null,
        selectedConversation: null,
        messages: [],
        newMessage: '',
        currentUserId: null,
        sending: false,
        showNewConversationModal: false,
        newConversationProperty: '',
        properties: [],
        pollingInterval: null,

        async init() {
            await this.loadCurrentUser();
            await this.loadConversations();
            await this.loadProperties();
            this.startPolling();
        },

        async loadCurrentUser() {
            try {
                const response = await fetch('/api/user/current/');
                const data = await response.json();
                if (data.user || data.id) {
                    this.currentUserId = data.user?.id || data.id;
                }
            } catch (err) {
                console.error('Failed to load current user:', err);
            }
        },

        async loadConversations() {
            try {
                const response = await fetch('/api/v1/conversations/');
                const data = await response.json();
                if (data.success) {
                    this.conversations = data.data || [];
                }
            } catch (err) {
                console.error('Failed to load conversations:', err);
            }
        },

        async loadProperties() {
            try {
                const response = await fetch('/api/v1/properties/');
                const data = await response.json();
                if (data.success) {
                    this.properties = data.data || [];
                }
            } catch (err) {
                console.error('Failed to load properties:', err);
            }
        },

        async selectConversation(conversationId) {
            this.selectedConversationId = conversationId;
            await this.loadMessages(conversationId);
        },

        async loadMessages(conversationId) {
            try {
                const response = await fetch(`/api/v1/conversations/${conversationId}/`);
                const data = await response.json();
                if (data.success) {
                    this.selectedConversation = data.data;
                    this.messages = data.data.messages || [];
                    this.scrollToBottom();
                }
            } catch (err) {
                console.error('Failed to load messages:', err);
            }
        },

        async sendMessage() {
            if (!this.newMessage.trim() || !this.selectedConversationId) return;

            this.sending = true;
            try {
                const response = await fetch(`/api/v1/conversations/${this.selectedConversationId}/messages/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCSRFToken(),
                    },
                    body: JSON.stringify({
                        content: this.newMessage.trim(),
                    }),
                });

                const data = await response.json();
                if (data.success) {
                    this.newMessage = '';
                    await this.loadMessages(this.selectedConversationId);
                    await this.loadConversations();
                } else {
                    alert('Failed to send message: ' + (data.error || 'Unknown error'));
                }
            } catch (err) {
                alert('Failed to send message: ' + err.message);
            } finally {
                this.sending = false;
            }
        },

        async createConversation() {
            if (!this.newConversationProperty) return;

            try {
                const response = await fetch('/api/v1/conversations/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCSRFToken(),
                    },
                    body: JSON.stringify({
                        property_id: this.newConversationProperty,
                    }),
                });

                const data = await response.json();
                if (data.success) {
                    this.showNewConversationModal = false;
                    this.newConversationProperty = '';
                    await this.loadConversations();
                    if (data.data) {
                        await this.selectConversation(data.data.id);
                    }
                } else {
                    alert('Failed to create conversation: ' + (data.error || 'Unknown error'));
                }
            } catch (err) {
                alert('Failed to create conversation: ' + err.message);
            }
        },

        startPolling() {
            // Poll every 5 seconds for new messages
            this.pollingInterval = setInterval(async () => {
                if (this.selectedConversationId) {
                    await this.loadMessages(this.selectedConversationId);
                }
                await this.loadConversations();
            }, 5000);
        },

        scrollToBottom() {
            this.$nextTick(() => {
                const container = document.getElementById('messages-container');
                if (container) {
                    container.scrollTop = container.scrollHeight;
                }
            });
        },

        formatTime(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return minutes + 'm ago';
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return hours + 'h ago';
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        },

        formatDateTime(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                hour: 'numeric', 
                minute: '2-digit' 
            });
        },

        getCSRFToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
        },
    };
}
</script>
{% endblock %}
