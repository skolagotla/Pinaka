{% extends 'frontend/admin/base.html' %}

{% block title %}Platform Settings - Pinaka Admin{% endblock %}

{% block content %}
<div class="p-6">
    <!-- Page Header -->
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
            <i class="fas fa-cog mr-2"></i>Platform Configuration
        </h1>
        <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">Manage platform-wide settings and feature flags</p>
    </div>

    <form method="post" id="settingsForm" 
          hx-post="{% url 'admin_api_update_settings' %}" 
          hx-swap="none"
          hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
          enctype="application/json">
        
        <!-- System Settings -->
        <div class="bg-white rounded-lg shadow mb-6 p-6">
            <h2 class="text-xl font-semibold mb-4">System Settings</h2>
            <div class="flex items-center justify-between mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Maintenance Mode</label>
                    <p class="text-sm text-gray-500 dark:text-gray-400">When enabled, the platform will be unavailable to users.</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" name="maintenanceMode" value="true" class="sr-only peer" {% if settings.maintenanceMode %}checked{% endif %}>
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                </label>
            </div>
        </div>

        <!-- Feature Flags -->
        <div class="bg-white rounded-lg shadow mb-6 p-6">
            <h2 class="text-xl font-semibold mb-4">Feature Flags</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="flex items-center justify-between">
                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Tenant Invitations</label>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" name="featureFlags[tenantInvitations]" value="true" class="sr-only peer" {% if settings.featureFlags.tenantInvitations %}checked{% endif %}>
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
                <div class="flex items-center justify-between">
                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Document Vault</label>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" name="featureFlags[documentVault]" value="true" class="sr-only peer" {% if settings.featureFlags.documentVault %}checked{% endif %}>
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
                <div class="flex items-center justify-between">
                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Maintenance Requests</label>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" name="featureFlags[maintenanceRequests]" value="true" class="sr-only peer" {% if settings.featureFlags.maintenanceRequests %}checked{% endif %}>
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
                <div class="flex items-center justify-between">
                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Rent Payments</label>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" name="featureFlags[rentPayments]" value="true" class="sr-only peer" {% if settings.featureFlags.rentPayments %}checked{% endif %}>
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
            </div>
        </div>

        <!-- Email Configuration -->
        <div class="bg-white rounded-lg shadow mb-6 p-6">
            <h2 class="text-xl font-semibold mb-4">Email Configuration</h2>
            <div class="flex items-center justify-between mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Enable Email</label>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" name="email[enabled]" value="true" class="sr-only peer" {% if settings.email.enabled %}checked{% endif %}>
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                </label>
            </div>
            <div class="mt-4">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Email Provider</label>
                <p class="text-sm text-gray-600 dark:text-gray-400">{{ settings.email.provider|default:"gmail" }}</p>
            </div>
        </div>

        <!-- Notifications -->
        <div class="bg-white rounded-lg shadow mb-6 p-6">
            <h2 class="text-xl font-semibold mb-4">Notifications</h2>
            <div class="flex items-center justify-between mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Enable Notifications</label>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" name="notifications[enabled]" value="true" class="sr-only peer" {% if settings.notifications.enabled %}checked{% endif %}>
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                </label>
            </div>
            <div class="mt-4">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Notification Channels</label>
                <p class="text-sm text-gray-600 dark:text-gray-400">{{ settings.notifications.channels|join:", "|default:"email" }}</p>
            </div>
        </div>

        <!-- Actions -->
        <div class="flex justify-end gap-4">
            <button type="button" onclick="location.reload()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg">
                Reset
            </button>
            <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                Save Settings
            </button>
        </div>
    </form>
</div>

<script>
// Convert form data to JSON for API
document.getElementById('settingsForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Build settings object from form checkboxes
    const settings = {
        maintenanceMode: document.getElementById('maintenanceMode')?.checked || false,
        featureFlags: {
            tenantInvitations: document.querySelector('input[name="featureFlags[tenantInvitations]"]')?.checked || false,
            documentVault: document.querySelector('input[name="featureFlags[documentVault]"]')?.checked || false,
            maintenanceRequests: document.querySelector('input[name="featureFlags[maintenanceRequests]"]')?.checked || false,
            rentPayments: document.querySelector('input[name="featureFlags[rentPayments]"]')?.checked || false,
        },
        email: {
            enabled: document.querySelector('input[name="email[enabled]"]')?.checked || false,
            provider: '{{ settings.email.provider|default:"gmail" }}',
        },
        notifications: {
            enabled: document.querySelector('input[name="notifications[enabled]"]')?.checked || false,
            channels: ['email'],
        },
    };
    
    // Send JSON via fetch
    fetch('{% url "admin_api_update_settings" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
        },
        body: JSON.stringify(settings),
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Settings saved successfully', 'success');
            // Optionally reload to show updated values
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.error || 'Failed to save settings', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('An error occurred. Please try again.', 'error');
    });
});

// Handle HTMX responses
document.body.addEventListener('htmx:afterRequest', function(event) {
    if (event.detail.pathInfo.requestPath.includes('settings/update')) {
        if (event.detail.xhr.status === 200) {
            const response = JSON.parse(event.detail.xhr.responseText);
            if (response.success) {
                showToast('Settings saved successfully', 'success');
            } else {
                showToast(response.error || 'Failed to save settings', 'error');
            }
        } else {
            showToast('An error occurred. Please try again.', 'error');
        }
    }
});
</script>
{% endblock %}
