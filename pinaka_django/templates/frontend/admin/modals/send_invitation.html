<!-- Send Invitation Modal -->
<div id="send-invitation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full mx-4">
        <div class="p-6 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-semibold text-gray-900">Send Invitation</h3>
                <button onclick="closeInvitationModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        
        <form id="send-invitation-form" class="p-6" hx-post="/admin/api/invitations/" hx-target="#invitation-result" hx-swap="innerHTML">
            <div id="invitation-result" class="mb-4"></div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Invitation Type</label>
                <select name="type" id="invitation-type" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                    <option value="landlord">Landlord</option>
                    <option value="pmc">Property Management Company (PMC)</option>
                    <option value="vendor">Vendor</option>
                    <option value="contractor">Contractor</option>
                </select>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                <input type="email" name="email" id="invitation-email" 
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                       placeholder="email@example.com" required>
            </div>
            
            <!-- Type-specific fields -->
            <div id="invitation-pmc-fields" class="mb-4 hidden">
                <label class="block text-sm font-medium text-gray-700 mb-2">Company Name (Optional)</label>
                <input type="text" name="companyName" id="invitation-company-name" 
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                       placeholder="ABC Property Management">
            </div>
            
            <div id="invitation-vendor-fields" class="mb-4 hidden">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Business Name (Optional)</label>
                        <input type="text" name="businessName" id="invitation-business-name" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                               placeholder="ABC Services">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Contact Name (Optional)</label>
                        <input type="text" name="contactName" id="invitation-contact-name" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                               placeholder="John Doe">
                    </div>
                </div>
            </div>
            
            <div id="invitation-landlord-fields" class="mb-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">First Name (Optional)</label>
                        <input type="text" name="firstName" id="invitation-first-name" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                               placeholder="John">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Last Name (Optional)</label>
                        <input type="text" name="lastName" id="invitation-last-name" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                               placeholder="Doe">
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end gap-3 pt-4 border-t border-gray-200">
                <button type="button" onclick="closeInvitationModal()" 
                        class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg">
                    Cancel
                </button>
                <button type="submit" 
                        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                    Send Invitation
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function showInvitationModal() {
    document.getElementById('send-invitation-modal').classList.remove('hidden');
}

function closeInvitationModal() {
    document.getElementById('send-invitation-modal').classList.add('hidden');
    document.getElementById('send-invitation-form').reset();
    document.getElementById('invitation-result').innerHTML = '';
}

// Handle invitation type change
document.getElementById('invitation-type').addEventListener('change', function() {
    const type = this.value;
    
    // Hide all type-specific fields
    document.getElementById('invitation-pmc-fields').classList.add('hidden');
    document.getElementById('invitation-vendor-fields').classList.add('hidden');
    document.getElementById('invitation-landlord-fields').classList.add('hidden');
    
    // Show relevant fields
    if (type === 'pmc') {
        document.getElementById('invitation-pmc-fields').classList.remove('hidden');
    } else if (type === 'vendor' || type === 'contractor') {
        document.getElementById('invitation-vendor-fields').classList.remove('hidden');
    } else {
        document.getElementById('invitation-landlord-fields').classList.remove('hidden');
    }
});

// Handle form submission
document.getElementById('send-invitation-form').addEventListener('htmx:afterRequest', function(event) {
    if (event.detail.xhr.status === 200) {
        const response = JSON.parse(event.detail.xhr.responseText);
        if (response.success) {
            showToast('Invitation sent successfully!', 'success');
            closeInvitationModal();
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(response.error || 'Failed to send invitation', 'error');
        }
    }
});

// Update form to send JSON
document.getElementById('send-invitation-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const data = {
        email: formData.get('email'),
        type: formData.get('type'),
        metadata: {}
    };
    
    const type = formData.get('type');
    if (type === 'pmc' && formData.get('companyName')) {
        data.metadata.companyName = formData.get('companyName');
    } else if ((type === 'vendor' || type === 'contractor')) {
        if (formData.get('businessName')) data.metadata.businessName = formData.get('businessName');
        if (formData.get('contactName')) data.metadata.contactName = formData.get('contactName');
    } else {
        if (formData.get('firstName')) data.metadata.firstName = formData.get('firstName');
        if (formData.get('lastName')) data.metadata.lastName = formData.get('lastName');
    }
    
    fetch('/admin/api/invitations/', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast('Invitation sent successfully!', 'success');
            closeInvitationModal();
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.error || 'Failed to send invitation', 'error');
        }
    });
});
</script>

