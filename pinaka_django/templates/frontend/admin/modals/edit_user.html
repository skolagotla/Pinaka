<!-- Edit User Modal -->
<div id="edit-user-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-semibold text-gray-900">Edit User</h3>
                <button onclick="closeEditUserModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        
        <form id="edit-user-form" class="p-6" hx-patch="/admin/api/users/{userId}/" hx-target="#edit-user-result" hx-swap="innerHTML">
            <input type="hidden" name="role" id="edit-user-role">
            
            <div id="edit-user-result" class="mb-4"></div>
            
            <!-- User Type Specific Fields -->
            <div id="edit-pmc-fields" class="hidden">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Company Name</label>
                    <input type="text" name="companyName" id="edit-company-name" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                </div>
            </div>
            
            <div id="edit-regular-fields">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">First Name</label>
                        <input type="text" name="firstName" id="edit-first-name" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Last Name</label>
                        <input type="text" name="lastName" id="edit-last-name" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Phone</label>
                    <input type="tel" name="phone" id="edit-phone" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" name="email" id="edit-email" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                    <select name="role" id="edit-role-select" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" disabled>
                        <option value="admin">Admin</option>
                        <option value="landlord">Landlord</option>
                        <option value="pmc">PMC</option>
                        <option value="tenant">Tenant</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                    <select name="status" id="edit-status" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="active">Active</option>
                        <option value="pending">Pending</option>
                        <option value="inactive">Inactive</option>
                        <option value="locked" id="edit-status-locked" class="hidden">Locked</option>
                    </select>
                </div>
            </div>
            
            <!-- RBAC Role Assignment (for admins) -->
            <div id="edit-rbac-section" class="mb-4 hidden">
                <label class="block text-sm font-medium text-gray-700 mb-2">RBAC Role</label>
                <select name="rbacRoleId" id="edit-rbac-role" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="">Select Role</option>
                </select>
                
                <!-- PMC Selector (for PMC_ADMIN role) -->
                <div id="edit-pmc-selector" class="mt-4 hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">PMC Company</label>
                    <select name="pmcId" id="edit-pmc-id" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Select PMC</option>
                    </select>
                </div>
            </div>
            
            <div class="flex justify-end gap-3 pt-4 border-t border-gray-200">
                <button type="button" onclick="closeEditUserModal()" 
                        class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg">
                    Cancel
                </button>
                <button type="submit" 
                        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                    Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

<script>
let currentEditUserId = null;
let currentEditUserType = null;

function editUser(userId, userRole) {
    currentEditUserId = userId;
    currentEditUserType = userRole;
    
    // Update form action
    const form = document.getElementById('edit-user-form');
    form.setAttribute('hx-patch', `/admin/api/users/${userId}/`);
    
    // Show modal
    document.getElementById('edit-user-modal').classList.remove('hidden');
    
    // Load user data
    fetch(`/admin/api/users/${userId}/${userRole}/`)
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const user = data.data;
                
                // Set form values
                document.getElementById('edit-user-role').value = user.role;
                document.getElementById('edit-role-select').value = user.role;
                document.getElementById('edit-status').value = user.status;
                
                if (user.role === 'pmc') {
                    document.getElementById('edit-pmc-fields').classList.remove('hidden');
                    document.getElementById('edit-regular-fields').classList.add('hidden');
                    document.getElementById('edit-company-name').value = user.companyName || '';
                } else {
                    document.getElementById('edit-pmc-fields').classList.add('hidden');
                    document.getElementById('edit-regular-fields').classList.remove('hidden');
                    document.getElementById('edit-first-name').value = user.firstName || '';
                    document.getElementById('edit-last-name').value = user.lastName || '';
                }
                
                document.getElementById('edit-phone').value = user.phone || '';
                document.getElementById('edit-email').value = user.email || '';
                
                // Show locked option for admins
                if (user.role === 'admin') {
                    document.getElementById('edit-status-locked').classList.remove('hidden');
                } else {
                    document.getElementById('edit-status-locked').classList.add('hidden');
                }
                
                // Load RBAC roles if admin
                if (user.role === 'admin') {
                    document.getElementById('edit-rbac-section').classList.remove('hidden');
                    loadRBACRoles(userId, userRole);
                } else {
                    document.getElementById('edit-rbac-section').classList.add('hidden');
                }
            }
        });
}

function closeEditUserModal() {
    document.getElementById('edit-user-modal').classList.add('hidden');
    document.getElementById('edit-user-form').reset();
}

function loadRBACRoles(userId, userType) {
    // Load available roles
    fetch('/admin/api/roles/')
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById('edit-rbac-role');
                select.innerHTML = '<option value="">Select Role</option>';
                data.data.forEach(role => {
                    const option = document.createElement('option');
                    option.value = role.id;
                    option.textContent = role.displayName || role.name;
                    select.appendChild(option);
                });
                
                // Load user's current roles
                fetch(`/admin/api/users/${userId}/roles/${userType}/`)
                    .then(res => res.json())
                    .then(roleData => {
                        if (roleData.success && roleData.data.length > 0) {
                            const userRole = roleData.data[0];
                            select.value = userRole.roleId;
                            
                            // Show PMC selector if PMC_ADMIN
                            if (userRole.roleName === 'PMC_ADMIN') {
                                document.getElementById('edit-pmc-selector').classList.remove('hidden');
                                loadPMCs(userRole.pmcId);
                            }
                        }
                    })
                    .catch(err => console.error('Error loading user roles:', err));
            }
        });
    
    // Watch for role change
    document.getElementById('edit-rbac-role').addEventListener('change', function() {
        const roleId = this.value;
        fetch(`/admin/api/roles/`)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const role = data.data.find(r => r.id === roleId);
                    if (role && role.name === 'PMC_ADMIN') {
                        document.getElementById('edit-pmc-selector').classList.remove('hidden');
                        loadPMCs();
                    } else {
                        document.getElementById('edit-pmc-selector').classList.add('hidden');
                    }
                }
            });
    });
}

function loadPMCs(selectedId = null) {
    fetch('/admin/api/pmcs/')
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById('edit-pmc-id');
                select.innerHTML = '<option value="">Select PMC</option>';
                data.data.forEach(pmc => {
                    const option = document.createElement('option');
                    option.value = pmc.id;
                    option.textContent = `${pmc.companyName} (${pmc.email})`;
                    if (selectedId && pmc.id === selectedId) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
            }
        });
}

// Handle form submission with proper JSON
document.getElementById('edit-user-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const userId = currentEditUserId;
    
    const data = {
        role: formData.get('role'),
        status: formData.get('status'),
    };
    
    // Add type-specific fields
    if (data.role === 'pmc') {
        data.companyName = formData.get('companyName');
        data.phone = formData.get('phone');
        data.email = formData.get('email');
    } else {
        data.firstName = formData.get('firstName');
        data.lastName = formData.get('lastName');
        data.phone = formData.get('phone');
        data.email = formData.get('email');
    }
    
    // Add RBAC role if admin
    if (data.role === 'admin') {
        const rbacRoleId = formData.get('rbacRoleId');
        if (rbacRoleId) {
            data.rbacRoleId = rbacRoleId;
            const pmcId = formData.get('pmcId');
            if (pmcId) {
                data.pmcId = pmcId;
            }
        }
    }
    
    fetch(`/admin/api/users/${userId}/`, {
        method: 'PATCH',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(response => {
        if (response.success) {
            showToast('User updated successfully!', 'success');
            closeEditUserModal();
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(response.error || 'Failed to update user', 'error');
        }
    })
    .catch(err => {
        showToast('Error updating user: ' + err.message, 'error');
    });
});
</script>

